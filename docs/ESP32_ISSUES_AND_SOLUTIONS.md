# ESP32 피지컬 트윈 - 발견된 문제 및 해결사항

**작성일**: 2024-12-11  
**상태**: ⚠️ 주의 필요

---

## 🔴 중요 발견 사항

### 1. ESP32-C3 GPIO 핀 매핑 불일치

**문제**:
- 펌웨어 코드에서 **GPIO 9**와 **GPIO 20**을 사용하고 있음
- 실제 하드웨어는 **ESP32-C3**로 업로드됨
- ESP32-C3와 ESP32는 GPIO 핀 매핑이 다름

**영향**:
- GPIO 20은 ESP32-C3에서 존재하지 않을 수 있음
- GPIO 9는 ESP32-C3에서 다른 기능으로 매핑될 수 있음
- 서보 및 LED가 정상 작동하지 않을 수 있음

**해결 방안**:

#### 옵션 A: ESP32-C3에 맞는 GPIO 핀으로 변경 (권장)

ESP32-C3에서 사용 가능한 GPIO 핀:
- **GPIO 0-21**: 일반 GPIO (일부는 특수 기능)
- **GPIO 2, 3, 4, 5**: 안전한 GPIO (부트 모드에 영향 없음)
- **GPIO 8, 9**: 사용 가능하나 부트 모드 확인 필요

**권장 핀 매핑 (ESP32-C3)**:
```cpp
#define SERVO_PIN 2   // GPIO 2 (PWM 가능, 안전)
#define LED_PIN 3     // GPIO 3 (PWM 가능, 안전)
```

#### 옵션 B: 실제 하드웨어 보드 확인

MinArq 보드의 실제 GPIO 핀 번호 확인:
- 보드 문서 확인
- 실제 물리적 핀 번호 확인
- 보드의 G9, G20이 ESP32-C3의 어떤 GPIO에 매핑되는지 확인

---

## ⚠️ 잠재적 문제

### 2. Web Serial API 브라우저 호환성

**현재 상태**: ✅ 해결됨
- Chrome/Edge만 지원
- Firefox/Safari 미지원
- 에러 메시지로 안내됨

### 3. 시리얼 통신 타임아웃

**현재 상태**: ✅ 해결됨
- Fire-and-forget 패턴 사용
- 블로킹 방지 구현됨

### 4. 전원 공급

**주의사항**:
- AA × 4 배터리 팩으로 서보 + LED 동시 구동
- 전류 부족 시 ESP32-C3 리셋 가능
- LED 밝기 제한 (50-100)으로 완화

**권장사항**:
- 실제 운영 시 LED 밝기 70-80으로 제한
- 서보 이동 속도 제한 (2도/루프) 유지

---

## ✅ 해결된 문제

### 1. ESP32-C3 칩 감지
- **문제**: 초기 설정이 ESP32용이었음
- **해결**: `platformio.ini`에서 `board = esp32-c3-devkitm-1`로 변경
- **상태**: ✅ 해결됨

### 2. Servo.h 헤더 파일
- **문제**: `Servo.h`를 찾을 수 없음
- **해결**: ESP32Servo 라이브러리 설치 및 `#include <ESP32Servo.h>`로 변경
- **상태**: ✅ 해결됨

### 3. 함수 선언 순서
- **문제**: 함수가 사용되기 전에 선언되지 않음
- **해결**: Forward declaration 추가
- **상태**: ✅ 해결됨

---

## 🔧 즉시 조치 필요 사항

### 1. GPIO 핀 번호 확인 및 수정

**확인 방법**:
1. MinArq 보드 문서에서 실제 GPIO 매핑 확인
2. 또는 물리적 핀 번호 확인

**수정 방법**:
```cpp
// esp32_firmware/src/main.cpp 수정
#define SERVO_PIN 2   // 실제 GPIO 번호로 변경
#define LED_PIN 3     // 실제 GPIO 번호로 변경
```

**테스트 방법**:
1. 펌웨어 재업로드
2. 서보 동작 확인
3. LED 동작 확인

### 2. 하드웨어 테스트

**필수 테스트**:
- [ ] 서보모터가 정상적으로 움직이는지 확인
- [ ] LED 매트릭스가 정상적으로 켜지는지 확인
- [ ] Web Serial 연결 시 데이터 수신 확인
- [ ] 핸드포즈 입력 시 물리 배 동기화 확인

---

## 📋 체크리스트

### 펌웨어
- [x] ESP32-C3 보드 설정 완료
- [x] 빌드 성공
- [x] 업로드 성공
- [ ] GPIO 핀 번호 확인 필요 ⚠️
- [ ] 하드웨어 테스트 필요 ⚠️

### 웹 애플리케이션
- [x] 빌드 성공
- [x] 배포 완료
- [x] Web Serial API 통합 완료
- [x] 에러 처리 완료

---

## 🚀 다음 단계

### 즉시 실행
1. **GPIO 핀 번호 확인**
   - MinArq 보드 문서 확인
   - 또는 실제 하드웨어 테스트

2. **펌웨어 수정 및 재업로드**
   - 올바른 GPIO 번호로 수정
   - 재빌드 및 업로드

3. **하드웨어 테스트**
   - 서보 동작 확인
   - LED 동작 확인
   - Web Serial 통신 확인

### 향후 개선
- [ ] GPIO 핀 번호 문서화
- [ ] 하드웨어 테스트 결과 문서화
- [ ] Phase 2: MPU-6050 활성화

---

## 📝 참고사항

### ESP32-C3 GPIO 제약사항
- GPIO 0: 부트 모드 (부팅 시 LOW = 다운로드 모드)
- GPIO 9: USB D- (USB 기능 사용 시 제한)
- GPIO 19, 20, 21: 존재하지 않음

### 권장 GPIO 핀
- **GPIO 2, 3, 4, 5**: 가장 안전한 GPIO
- **GPIO 6, 7**: SPI 기능 있으나 GPIO로 사용 가능
- **GPIO 8**: 사용 가능

---

**중요**: GPIO 핀 번호를 확인하고 수정한 후 하드웨어 테스트를 반드시 수행하세요.

